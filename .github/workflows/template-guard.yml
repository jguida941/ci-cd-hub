name: Template Guard

on:
  pull_request:
    paths:
      - "templates/**"
      - "cihub/commands/templates.py"
      - "cihub/cli.py"
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Local validation (runs on all PRs, no secrets needed)
  validate-local:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install CLI deps
        run: python -m pip install -e ".[dev]"

      - name: Validate templates
        run: python -m pytest tests/test_templates.py tests/test_commands_scaffold.py -v --tb=short

  # Remote sync check (schedule/dispatch only, needs token)
  guard:
    if: github.event_name != 'pull_request' && github.repository == 'jguida941/ci-cd-hub'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Install CLI deps
        run: python -m pip install -e ".[dev]"

      - name: Check remote template drift
        env:
          GH_TOKEN: ${{ secrets.HUB_DISPATCH_TOKEN }}
        run: python -m cihub sync-templates --check
