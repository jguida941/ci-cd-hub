# ============================================================================
# CI/CD Hub - Smoke Test
# ============================================================================
# Quick validation test using minimal Java and Python repos.
# Runs core tools only (heavy tools like mutation/OWASP disabled for speed).
#
# Purpose:
#   - Verify hub can discover and test repositories
#   - Validate tool execution and metric collection
#   - Ensure artifacts and summaries are generated
#   - Quick feedback before full hub runs
#
# See: docs/development/execution/SMOKE_TEST.md for detailed documentation
# ============================================================================

name: "Smoke Test"

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      skip_mutation:
        description: 'Skip mutation testing (faster - recommended)'
        required: false
        type: boolean
        default: true
      write_github_summary:
        description: 'Write summary to GITHUB_STEP_SUMMARY'
        required: false
        type: boolean
        default: true
      harden_runner_policy:
        description: 'Harden-runner policy: audit (default), block, or disabled'
        required: false
        type: string
        default: 'audit'

  # Allow running smoke test on config changes
  pull_request:
    paths:
      - 'config/repos/smoke-test-*.yaml'
      - '.github/workflows/smoke-test.yml'

env:
  REPORTS_DIR: ${{ github.workspace }}/smoke-test-reports

jobs:
  # ============================================================================
  # Discover Smoke Test Repos
  # ============================================================================
  discover:
    name: Discover Smoke Test Repos
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.repos.outputs.matrix }}
      count: ${{ steps.repos.outputs.count }}

    steps:
      - name: Harden Runner
        if: ${{ inputs.harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: ${{ inputs.harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Build Smoke Test Matrix
        id: repos
        run: cihub discover --run-group smoke --github-output

      - name: Validate Smoke Test Setup
        env:
          REPO_COUNT: ${{ steps.repos.outputs.count }}
        run: cihub smoke-validate --count "$REPO_COUNT" --min-count 2

  # ============================================================================
  # Run Smoke Tests
  # ============================================================================
  test-repo:
    name: "Smoke Test: ${{ matrix.language }} (${{ matrix.name }})"
    runs-on: ubuntu-latest
    needs: discover
    if: needs.discover.outputs.count > 0
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Harden Runner
        if: ${{ inputs.harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: ${{ inputs.harden_runner_policy || 'audit' }}

      - name: Checkout Hub (for scripts)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          path: hub
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e "hub[ci]"

      - name: Checkout Target Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: ${{ matrix.owner }}/${{ matrix.name }}
          ref: ${{ matrix.branch }}
          path: repo
          fetch-depth: 0
          persist-credentials: false

      - name: Create Reports Directory
        run: mkdir -p reports

      # ========================================
      # JAVA SETUP & CORE TOOLS
      # ========================================
      - name: Set up JDK 21
        if: matrix.language == 'java'
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: "[Java] Build & Test"
        if: matrix.language == 'java'
        working-directory: repo
        run: cihub hub-ci smoke-java-build --path .
        continue-on-error: true

      - name: "[Java] Extract Test Results"
        if: matrix.language == 'java'
        id: java-tests
        working-directory: repo
        run: cihub hub-ci smoke-java-tests --path . --github-output

      - name: "[Java] Extract Coverage"
        if: matrix.language == 'java'
        id: java-coverage
        working-directory: repo
        run: cihub hub-ci smoke-java-coverage --path . --github-output

      - name: "[Java] Checkstyle"
        if: matrix.language == 'java'
        id: java-checkstyle
        working-directory: repo
        run: cihub hub-ci smoke-java-checkstyle --path . --github-output
        continue-on-error: true

      - name: "[Java] SpotBugs"
        if: matrix.language == 'java'
        id: java-spotbugs
        working-directory: repo
        run: cihub hub-ci smoke-java-spotbugs --path . --github-output
        continue-on-error: true

      # ========================================
      # PYTHON SETUP & CORE TOOLS
      # ========================================
      - name: Set up Python 3.12
        if: matrix.language == 'python'
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.12'

      - name: "[Python] Install Dependencies"
        if: matrix.language == 'python'
        working-directory: repo
        run: cihub hub-ci smoke-python-install --path .

      - name: "[Python] Run Tests with Coverage"
        if: matrix.language == 'python'
        id: python-tests
        working-directory: repo
        run: cihub hub-ci smoke-python-tests --path . --output-file test-output.txt --github-output
        continue-on-error: true

      - name: "[Python] Ruff Lint"
        if: matrix.language == 'python'
        id: python-ruff
        working-directory: repo
        run: cihub hub-ci smoke-python-ruff --path . --report ruff-report.json --github-output
        continue-on-error: true

      - name: "[Python] Black Format Check"
        if: matrix.language == 'python'
        id: python-black
        working-directory: repo
        run: cihub hub-ci smoke-python-black --path . --output-file black-output.txt --github-output
        continue-on-error: true

      # ========================================
      # GENERATE SMOKE TEST REPORT
      # ========================================
      - name: Generate Smoke Test Report
        id: report
        env:
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_BRANCH: ${{ matrix.branch }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          MATRIX_CONFIG: ${{ matrix.config_basename }}
          TESTS_TOTAL: ${{ matrix.language == 'java' && steps.java-tests.outputs.total || steps.python-tests.outputs.total || '0' }}
          TESTS_FAILED: ${{ matrix.language == 'java' && steps.java-tests.outputs.failed || steps.python-tests.outputs.failed || '0' }}
          COVERAGE: ${{ matrix.language == 'java' && steps.java-coverage.outputs.percent || steps.python-tests.outputs.coverage || '0' }}
          COVERAGE_LINES: ${{ steps.java-coverage.outputs.lines || '0 / 0' }}
          CHECKSTYLE_VIOLATIONS: ${{ steps.java-checkstyle.outputs.violations || '0' }}
          SPOTBUGS_ISSUES: ${{ steps.java-spotbugs.outputs.count || '0' }}
          RUFF_ERRORS: ${{ steps.python-ruff.outputs.errors || '0' }}
          RUFF_SECURITY: ${{ steps.python-ruff.outputs.security || '0' }}
          BLACK_ISSUES: ${{ steps.python-black.outputs.issues || '0' }}
        run: |
          cihub report smoke-summary --mode repo \
            --owner "$MATRIX_OWNER" \
            --repo "$MATRIX_NAME" \
            --branch "$MATRIX_BRANCH" \
            --language "$MATRIX_LANGUAGE" \
            --config "$MATRIX_CONFIG" \
            --tests-total "$TESTS_TOTAL" \
            --tests-failed "$TESTS_FAILED" \
            --coverage "$COVERAGE" \
            --coverage-lines "$COVERAGE_LINES" \
            --checkstyle-violations "$CHECKSTYLE_VIOLATIONS" \
            --spotbugs-issues "$SPOTBUGS_ISSUES" \
            --ruff-errors "$RUFF_ERRORS" \
            --ruff-security "$RUFF_SECURITY" \
            --black-issues "$BLACK_ISSUES"

      # ========================================
      # UPLOAD ARTIFACTS
      # ========================================
      - name: Upload Smoke Test Artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: smoke-test-${{ matrix.language }}-${{ matrix.name }}
          path: |
            repo/**/target/surefire-reports/
            repo/**/target/site/jacoco/
            repo/**/target/checkstyle-result.xml
            repo/**/target/spotbugsXml.xml
            repo/coverage.xml
            repo/htmlcov/
            repo/*-report.json
            repo/test-output.txt
          retention-days: 7
          if-no-files-found: warn

  # ============================================================================
  # Smoke Test Summary
  # ============================================================================
  summary:
    name: Smoke Test Summary
    runs-on: ubuntu-latest
    needs: [discover, test-repo]
    if: always()

    steps:
      - name: Harden Runner
        if: ${{ inputs.harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: ${{ inputs.harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Download All Artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: smoke-test-artifacts

      - name: Generate Summary
        env:
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
          REPO_COUNT: ${{ needs.discover.outputs.count }}
          RUN_NUMBER: ${{ github.run_number }}
          EVENT_NAME: ${{ github.event_name }}
          TEST_RESULT: ${{ needs.test-repo.result }}
        run: cihub report smoke-summary --mode overall --repo-count "$REPO_COUNT" --run-number "$RUN_NUMBER" --event-name "$EVENT_NAME" --test-result "$TEST_RESULT"

      - name: Check Smoke Test Result
        env:
          TEST_RESULT: ${{ needs.test-repo.result }}
        run: cihub smoke-validate --status "$TEST_RESULT"
