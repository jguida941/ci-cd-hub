# ============================================================================
# CI/CD Hub - Main Orchestrator
# ============================================================================
# This workflow orchestrates CI/CD for all configured repositories.
# It reads config, triggers builds, and aggregates reports.
#
# Settings Architecture:
#   - Operational settings: config/hub-settings.yaml (edit with: cihub hub config set)
#   - Per-repo configs: config/repos/*.yaml (edit with wizard or CLI)
#   - Workflow inputs below are OVERRIDES for one-off runs (take precedence over config)
#
# Triggers:
#   - Manual dispatch (workflow_dispatch)
#   - Scheduled (e.g., nightly)
#   - When config changes
# ============================================================================

name: Hub Orchestrator

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Comma-separated repo names (empty = all)'
        required: false
        type: string
      # OVERRIDE inputs - leave empty to use config/hub-settings.yaml values
      write_github_summary:
        description: 'Override: Write summary to GITHUB_STEP_SUMMARY'
        required: false
        type: string
        default: ''
      include_details:
        description: 'Override: Include per-repo details in summary'
        required: false
        type: string
        default: ''
      cihub_debug:
        description: 'Override: Enable CIHUB_DEBUG'
        required: false
        type: string
        default: ''
      cihub_verbose:
        description: 'Override: Enable CIHUB_VERBOSE'
        required: false
        type: string
        default: ''
      cihub_debug_context:
        description: 'Override: Enable CIHUB_DEBUG_CONTEXT'
        required: false
        type: string
        default: ''
      cihub_emit_triage:
        description: 'Override: Enable CIHUB_EMIT_TRIAGE'
        required: false
        type: string
        default: ''
      harden_runner_policy:
        description: 'Override: Harden-runner policy (audit/block/disabled)'
        required: false
        type: string
        default: ''

  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

  push:
    branches: [main, master]
    paths:
      - 'config/**'
      - '.github/workflows/hub-orchestrator.yml'

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

# Prevent concurrent runs for the same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Load Hub Settings (config-file-first pattern)
  # ============================================================================
  load-settings:
    name: Load Hub Settings
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      # Execution settings (flattened keys from hub-settings.yaml)
      write_github_summary: ${{ steps.resolve.outputs.execution_write_github_summary }}
      include_details: ${{ steps.resolve.outputs.execution_include_details }}
      # Debug settings
      debug_enabled: ${{ steps.resolve.outputs.debug_enabled }}
      debug_verbose: ${{ steps.resolve.outputs.debug_verbose }}
      debug_debug_context: ${{ steps.resolve.outputs.debug_debug_context }}
      debug_emit_triage: ${{ steps.resolve.outputs.debug_emit_triage }}
      # Security settings
      security_harden_runner_policy: ${{ steps.resolve.outputs.security_harden_runner_policy }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
          sparse-checkout: |
            config/hub-settings.yaml
            cihub
            pyproject.toml
          sparse-checkout-cone-mode: false

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub (minimal)
        run: pip install -e .

      - name: Load Hub Settings
        id: resolve
        env:
          OVERRIDE_WRITE_SUMMARY: ${{ inputs.write_github_summary }}
          OVERRIDE_INCLUDE_DETAILS: ${{ inputs.include_details }}
          OVERRIDE_DEBUG: ${{ inputs.cihub_debug }}
          OVERRIDE_VERBOSE: ${{ inputs.cihub_verbose }}
          OVERRIDE_DEBUG_CONTEXT: ${{ inputs.cihub_debug_context }}
          OVERRIDE_EMIT_TRIAGE: ${{ inputs.cihub_emit_triage }}
          OVERRIDE_HARDEN_RUNNER_POLICY: ${{ inputs.harden_runner_policy }}
        run: |
          cihub hub config load --github-output \
            --override-write-summary "$OVERRIDE_WRITE_SUMMARY" \
            --override-include-details "$OVERRIDE_INCLUDE_DETAILS" \
            --override-debug "$OVERRIDE_DEBUG" \
            --override-verbose "$OVERRIDE_VERBOSE" \
            --override-debug-context "$OVERRIDE_DEBUG_CONTEXT" \
            --override-emit-triage "$OVERRIDE_EMIT_TRIAGE" \
            --override-harden-runner-policy "$OVERRIDE_HARDEN_RUNNER_POLICY"

  # ============================================================================
  # Load Configuration
  # ============================================================================
  load-config:
    name: Load Repository Config
    runs-on: ubuntu-latest
    needs: load-settings
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.config.outputs.matrix }}
      repo_count: ${{ steps.config.outputs.count }}
    env:
      CIHUB_DEBUG: ${{ needs.load-settings.outputs.debug_enabled == 'true' && 'True' || 'False' }}
      CIHUB_VERBOSE: ${{ needs.load-settings.outputs.debug_verbose == 'true' && 'True' || 'False' }}
      CIHUB_DEBUG_CONTEXT: ${{ needs.load-settings.outputs.debug_debug_context == 'true' && 'True' || 'False' }}
      CIHUB_EMIT_TRIAGE: ${{ needs.load-settings.outputs.debug_emit_triage == 'true' && 'True' || 'False' }}

    steps:
      - name: Harden Runner
        if: ${{ needs.load-settings.outputs.security_harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: ${{ needs.load-settings.outputs.security_harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Generate Build Matrix
        id: config
        env:
          INPUT_REPOS: ${{ inputs.repos || '' }}
        run: cihub discover --dispatch-only --repos "${INPUT_REPOS:-}" --github-output

      - name: Summary
        env:
          REPO_COUNT: ${{ steps.config.outputs.count }}
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ needs.load-settings.outputs.write_github_summary }}
        run: cihub report orchestrator-summary --mode load-config --repo-count "$REPO_COUNT"

  # ============================================================================
  # Trigger Builds for Each Repo
  # ============================================================================
  trigger-builds:
    name: Build ${{ matrix.config_basename }}
    runs-on: ubuntu-latest
    needs: [load-settings, load-config]
    if: needs.load-config.outputs.repo_count > 0
    permissions:
      contents: read
      actions: write  # For workflow dispatch
    env:
      CIHUB_DEBUG: ${{ needs.load-settings.outputs.debug_enabled == 'true' && 'True' || 'False' }}
      CIHUB_VERBOSE: ${{ needs.load-settings.outputs.debug_verbose == 'true' && 'True' || 'False' }}
      CIHUB_DEBUG_CONTEXT: ${{ needs.load-settings.outputs.debug_debug_context == 'true' && 'True' || 'False' }}
      CIHUB_EMIT_TRIAGE: ${{ needs.load-settings.outputs.debug_emit_triage == 'true' && 'True' || 'False' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.load-config.outputs.matrix) }}

    steps:
      - name: Harden Runner
        if: ${{ needs.load-settings.outputs.security_harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: ${{ needs.load-settings.outputs.security_harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Trigger Repository Workflow
        id: dispatch
        env:
          HUB_DISPATCH_TOKEN: ${{ secrets.HUB_DISPATCH_TOKEN || secrets.GITHUB_TOKEN }}
          CORRELATION_ID: ${{ github.run_id }}-${{ github.run_attempt || '1' }}-${{ matrix.config_basename }}
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_BRANCH: ${{ matrix.default_branch }}
          MATRIX_WORKFLOW: ${{ matrix.dispatch_workflow || 'hub-ci.yml' }}
          MATRIX_DISPATCH_ENABLED: ${{ matrix.dispatch_enabled }}
        run: |
          cihub dispatch trigger \
            --owner "$MATRIX_OWNER" \
            --repo "$MATRIX_NAME" \
            --ref "$MATRIX_BRANCH" \
            --workflow "$MATRIX_WORKFLOW" \
            --correlation-id "${CORRELATION_ID}" \
            --dispatch-enabled "$MATRIX_DISPATCH_ENABLED" \
            --timeout 1800

      - name: Record Build Trigger
        env:
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          MATRIX_BRANCH: ${{ matrix.default_branch }}
          STEP_WORKFLOW_ID: ${{ steps.dispatch.outputs.workflow_id }}
          STEP_RUN_ID: ${{ steps.dispatch.outputs.run_id }}
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ needs.load-settings.outputs.write_github_summary }}
        run: cihub report orchestrator-summary --mode trigger-record --owner "$MATRIX_OWNER" --repo "$MATRIX_NAME" --language "$MATRIX_LANGUAGE" --branch "$MATRIX_BRANCH" --workflow-id "$STEP_WORKFLOW_ID" --run-id "$STEP_RUN_ID" --status "Triggered"

      - name: Save Dispatch Metadata
        if: always()
        env:
          MATRIX_CONFIG_BASENAME: ${{ matrix.config_basename }}
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_SUBDIR: ${{ matrix.subdir }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          MATRIX_BRANCH: ${{ matrix.default_branch }}
          STEP_WORKFLOW_ID: ${{ steps.dispatch.outputs.workflow_id }}
          STEP_RUN_ID: ${{ steps.dispatch.outputs.run_id }}
          STEP_CORRELATION_ID: ${{ steps.dispatch.outputs.correlation_id }}
          JOB_STATUS: ${{ job.status }}
        run: |
          cihub dispatch metadata \
            --config-basename "$MATRIX_CONFIG_BASENAME" \
            --owner "$MATRIX_OWNER" \
            --repo "$MATRIX_NAME" \
            --output-dir dispatch-results \
            --subdir "$MATRIX_SUBDIR" \
            --language "$MATRIX_LANGUAGE" \
            --branch "$MATRIX_BRANCH" \
            --workflow "$STEP_WORKFLOW_ID" \
            --run-id "$STEP_RUN_ID" \
            --correlation-id "$STEP_CORRELATION_ID" \
            --status "$JOB_STATUS"

      - name: Upload Dispatch Metadata
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: dispatch-${{ matrix.config_basename_safe }}-${{ github.run_id }}
          path: dispatch-results/${{ matrix.config_basename }}.json
          retention-days: 7

  # ============================================================================
  # Aggregate Reports
  # ============================================================================
  aggregate-reports:
    name: Aggregate Reports
    runs-on: ubuntu-latest
    needs: [load-settings, load-config, trigger-builds]
    if: always()
    permissions:
      contents: read
      actions: read  # For reading run artifacts
    env:
      CIHUB_DEBUG: ${{ needs.load-settings.outputs.debug_enabled == 'true' && 'True' || 'False' }}
      CIHUB_VERBOSE: ${{ needs.load-settings.outputs.debug_verbose == 'true' && 'True' || 'False' }}
      CIHUB_DEBUG_CONTEXT: ${{ needs.load-settings.outputs.debug_debug_context == 'true' && 'True' || 'False' }}
      CIHUB_EMIT_TRIAGE: ${{ needs.load-settings.outputs.debug_emit_triage == 'true' && 'True' || 'False' }}

    steps:
      - name: Harden Runner
        if: ${{ needs.load-settings.outputs.security_harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: ${{ needs.load-settings.outputs.security_harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v5
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Download Dispatch Metadata
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4
        with:
          path: dispatch-artifacts
        continue-on-error: true

      - name: Generate Hub Summary and Report
        env:
          TOTAL_REPOS: ${{ needs.load-config.outputs.repo_count }}
          HUB_RUN_ID: ${{ github.run_id }}
          HUB_EVENT: ${{ github.event_name }}
          # Use HUB_DISPATCH_TOKEN for cross-repo artifact access
          HUB_DISPATCH_TOKEN: ${{ secrets.HUB_DISPATCH_TOKEN }}
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ needs.load-settings.outputs.write_github_summary }}
          CIHUB_REPORT_INCLUDE_DETAILS: ${{ needs.load-settings.outputs.include_details }}
        run: cihub report aggregate --dispatch-dir dispatch-artifacts --output hub-report.json --details-output hub-report-details.md --defaults-file config/defaults.yaml

      - name: Upload Hub Report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: hub-report-${{ github.run_id }}
          path: hub-report.json
          retention-days: 30

      - name: Upload Hub Report Details
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: hub-report-details-${{ github.run_id }}
          path: hub-report-details.md
          retention-days: 30
          if-no-files-found: warn
