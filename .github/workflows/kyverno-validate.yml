# ============================================================================
# Kyverno Policy Validation (Internal)
# ============================================================================
# Validates Kyverno policy syntax for the hub's own policies.
# Runs on changes to policy files to catch syntax errors early.
#
# For external repos, use the reusable kyverno-ci.yml workflow instead.
#
# See also: docs/adr/0012-kyverno-policies.md
# ============================================================================

name: "Kyverno: Validate Policies"

permissions:
  contents: read

on:
  push:
    paths:
      - 'policies/kyverno/**/*.yaml'
      - 'policies/kyverno/**/*.yml'
      - 'templates/kyverno/**/*.yaml'
      - 'templates/kyverno/**/*.yml'
  pull_request:
    paths:
      - 'policies/kyverno/**/*.yaml'
      - 'policies/kyverno/**/*.yml'
      - 'templates/kyverno/**/*.yaml'
      - 'templates/kyverno/**/*.yml'
  workflow_dispatch:
    inputs:
      write_github_summary:
        description: 'Write summary to GITHUB_STEP_SUMMARY'
        required: false
        type: boolean
        default: true

jobs:
  validate:
    name: Validate Policy Syntax
    runs-on: ubuntu-latest
    # Skip on tag pushes - path filters don't work for tags
    if: ${{ !startsWith(github.ref, 'refs/tags/') }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Install Kyverno CLI
        env:
          KYVERNO_VERSION: "v1.16.1"
        run: |
          set -euo pipefail
          echo "Installing Kyverno CLI ${KYVERNO_VERSION}..."
          # Filename keeps the v prefix: kyverno-cli_v1.16.1_linux_x86_64.tar.gz
          curl -sLO "https://github.com/kyverno/kyverno/releases/download/${KYVERNO_VERSION}/kyverno-cli_${KYVERNO_VERSION}_linux_x86_64.tar.gz"
          tar -xzf "kyverno-cli_${KYVERNO_VERSION}_linux_x86_64.tar.gz"
          sudo mv kyverno /usr/local/bin/
          rm "kyverno-cli_${KYVERNO_VERSION}_linux_x86_64.tar.gz"
          kyverno version
        shell: bash

      - name: Validate Policies
        id: validate
        run: |
          set -euo pipefail
          echo "Validating Kyverno policies..."

          FAILED=0
          VALIDATED=0

          # Validate all policy files
          shopt -s nullglob
          for policy in policies/kyverno/*.yaml policies/kyverno/*.yml; do
            if [ -f "$policy" ]; then
              echo "Validating: $policy"
              # Use apply with /dev/null - validates policy syntax
              OUTPUT=$(kyverno apply "$policy" --resource /dev/null 2>&1 || true)
              if echo "$OUTPUT" | grep -qi "error\|invalid"; then
                echo "  FAILED"
                echo "$OUTPUT"
                FAILED=$((FAILED + 1))
              else
                echo "  OK"
                VALIDATED=$((VALIDATED + 1))
              fi
            fi
          done

          # Validate template files if they exist
          if [ -d "templates/kyverno" ]; then
            for template in templates/kyverno/*.yaml templates/kyverno/*.yml; do
              if [ -f "$template" ]; then
                echo "Validating template: $template"
                OUTPUT=$(kyverno apply "$template" --resource /dev/null 2>&1 || true)
                if echo "$OUTPUT" | grep -qi "error\|invalid"; then
                  echo "  FAILED"
                  echo "$OUTPUT"
                  FAILED=$((FAILED + 1))
                else
                  echo "  OK"
                  VALIDATED=$((VALIDATED + 1))
                fi
              fi
            done
          fi

          {
            echo "validated=$VALIDATED"
            echo "failed=$FAILED"
          } >> "$GITHUB_OUTPUT"

          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED policy validation(s) failed"
            exit 1
          fi

          echo "All $VALIDATED policies validated successfully"
        shell: bash

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Generate Summary
        if: always()
        env:
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
        run: cihub report kyverno-summary --policies-dir "policies/kyverno" --validated "${{ steps.validate.outputs.validated || '0' }}" --failed "${{ steps.validate.outputs.failed || '0' }}" --run-tests "false" --title "# Kyverno Policy Validation (Hub)"
