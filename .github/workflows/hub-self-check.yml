# ============================================================================
# CI/CD Hub - Self Check
# ============================================================================
# Validates the hub itself: runs unit tests, validates templates, and checks
# Python syntax. Runs on push/PR to ensure hub integrity.
# ============================================================================

name: Hub Self-Check

on:
  push:
    branches: [main, master]
    paths:
      - 'scripts/**'
      - 'tests/**'
      - 'templates/**'
      - 'config/**'
      - 'schema/**'
      - '.github/workflows/hub-self-check.yml'
      - 'pyproject.toml'
      - 'requirements*.txt'
  pull_request:
    paths:
      - 'scripts/**'
      - 'tests/**'
      - 'templates/**'
      - 'config/**'
      - 'schema/**'
      - '.github/workflows/hub-self-check.yml'
      - 'pyproject.toml'
      - 'requirements*.txt'
  workflow_dispatch:

jobs:
  # ============================================================================
  # Python Syntax Check
  # ============================================================================
  syntax-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check Python syntax
        run: |
          echo "Checking Python syntax in scripts/..."
          python -m py_compile scripts/*.py
          echo "All Python files have valid syntax"

  # ============================================================================
  # Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pyyaml jsonschema

      - name: Run unit tests
        run: |
          python -m pytest tests/ -v --tb=short --junitxml=test-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml
          retention-days: 7

  # ============================================================================
  # Template Validation
  # ============================================================================
  validate-templates:
    name: Validate Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pyyaml jsonschema

      - name: Validate templates
        run: |
          python -m pytest tests/test_templates.py -v --tb=short

  # ============================================================================
  # Config Schema Validation
  # ============================================================================
  validate-configs:
    name: Validate Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Validate all repo configs
        run: |
          set -e
          for cfg in config/repos/*.yaml; do
            repo_name=$(basename "$cfg" .yaml)
            echo "Validating $cfg"
            python scripts/load_config.py --repo "$repo_name" --output workflow-inputs >/dev/null
          done
          echo "All configs valid"

  # ============================================================================
  # Matrix Key Verification
  # ============================================================================
  verify-matrix-keys:
    name: Verify Matrix Keys
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Verify matrix key coverage
        run: python scripts/verify_hub_matrix_keys.py

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Self-Check Summary
    runs-on: ubuntu-latest
    needs: [syntax-check, unit-tests, validate-templates, validate-configs, verify-matrix-keys]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Hub Self-Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.syntax-check.result }}" = "success" ]; then
            echo "- Python Syntax: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Python Syntax: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.unit-tests.result }}" = "success" ]; then
            echo "- Unit Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Unit Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-templates.result }}" = "success" ]; then
            echo "- Template Validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Template Validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-configs.result }}" = "success" ]; then
            echo "- Config Validation: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Config Validation: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.verify-matrix-keys.result }}" = "success" ]; then
            echo "- Matrix Keys: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Matrix Keys: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          # Fail if any check failed
          if [ "${{ needs.syntax-check.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.validate-templates.result }}" != "success" ] || \
             [ "${{ needs.validate-configs.result }}" != "success" ] || \
             [ "${{ needs.verify-matrix-keys.result }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Some checks failed. Please review.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All checks passed!**" >> $GITHUB_STEP_SUMMARY
