# ============================================================================
# CI/CD Hub - Central Test Runner
# ============================================================================
# This is the TRUE hub workflow - it clones and tests ALL your repos directly.
# Target repos DO NOT need any workflow files - the hub does everything.
#
# How it works:
#   1. cihub hub config load reads config/hub-settings.yaml for operational settings
#   2. cihub discover reads config/repos/*.yaml to get repo list
#   3. cihub ci clones and runs ALL quality tools for each repo
#   4. Artifacts uploaded centrally per repo
#
# Settings Architecture:
#   - Operational settings: config/hub-settings.yaml (edit with: cihub hub config set)
#   - Per-repo configs: config/repos/*.yaml (edit with wizard or CLI)
#   - Workflow inputs below are OVERRIDES for one-off runs (take precedence over config)
#
# This workflow is a THIN WRAPPER - all logic is in the cihub CLI.
# Per AGENTS.md: "Never write inline scripts in YAML workflows"
# ============================================================================

name: "Hub: Run All Repos"

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Specific repos (comma-separated, empty=all)'
        required: false
        type: string
      run_group:
        description: 'Run group filter (full, smoke, fixtures, or comma-separated)'
        required: false
        type: string
      # OVERRIDE inputs - leave empty to use config/hub-settings.yaml values
      skip_mutation:
        description: 'Override: Skip mutation testing'
        required: false
        type: string
        default: ''
      write_github_summary:
        description: 'Override: Write summary to GITHUB_STEP_SUMMARY'
        required: false
        type: string
        default: ''
      include_details:
        description: 'Override: Include per-repo details in summary'
        required: false
        type: string
        default: ''
      cihub_debug:
        description: 'Override: Enable CIHUB_DEBUG'
        required: false
        type: string
        default: ''
      cihub_verbose:
        description: 'Override: Enable CIHUB_VERBOSE'
        required: false
        type: string
        default: ''
      cihub_debug_context:
        description: 'Override: Enable CIHUB_DEBUG_CONTEXT'
        required: false
        type: string
        default: ''
      cihub_emit_triage:
        description: 'Override: Enable CIHUB_EMIT_TRIAGE'
        required: false
        type: string
        default: ''
      harden_runner_policy:
        description: 'Override: Harden-runner policy (audit/block/disabled)'
        required: false
        type: string
        default: ''

  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

  push:
    branches: [main, master]
    paths:
      - 'config/repos/*.yaml'

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

jobs:
  # ============================================================================
  # Load Hub Settings (config-file-first pattern)
  # ============================================================================
  # Reads config/hub-settings.yaml and exports values for use by other jobs.
  # Workflow inputs OVERRIDE config file values when provided (non-empty).
  # ============================================================================
  load-settings:
    name: Load Hub Settings
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      # Execution settings (flattened keys from hub-settings.yaml)
      skip_mutation: ${{ steps.resolve.outputs.execution_skip_mutation }}
      write_github_summary: ${{ steps.resolve.outputs.execution_write_github_summary }}
      include_details: ${{ steps.resolve.outputs.execution_include_details }}
      # Debug settings
      debug_enabled: ${{ steps.resolve.outputs.debug_enabled }}
      debug_verbose: ${{ steps.resolve.outputs.debug_verbose }}
      debug_debug_context: ${{ steps.resolve.outputs.debug_debug_context }}
      debug_emit_triage: ${{ steps.resolve.outputs.debug_emit_triage }}
      # Security settings
      security_harden_runner_policy: ${{ steps.resolve.outputs.security_harden_runner_policy }}

    steps:
      - name: Checkout Hub
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
          sparse-checkout: |
            config/hub-settings.yaml
            cihub
            pyproject.toml
          sparse-checkout-cone-mode: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install cihub (minimal)
        run: pip install -e .

      - name: Load Hub Settings
        id: resolve
        run: cihub hub config load --github-output --override-skip-mutation "${{ inputs.skip_mutation }}" --override-write-summary "${{ inputs.write_github_summary }}" --override-include-details "${{ inputs.include_details }}" --override-debug "${{ inputs.cihub_debug }}" --override-verbose "${{ inputs.cihub_verbose }}" --override-debug-context "${{ inputs.cihub_debug_context }}" --override-emit-triage "${{ inputs.cihub_emit_triage }}" --override-harden-runner-policy "${{ inputs.harden_runner_policy }}"

  # ============================================================================
  # Discover Repos (via cihub discover)
  # ============================================================================
  discover:
    name: Discover Repositories
    runs-on: ubuntu-latest
    needs: load-settings
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
      count: ${{ steps.discover.outputs.count }}
    env:
      CIHUB_DEBUG: ${{ needs.load-settings.outputs.debug_enabled == 'true' && 'True' || 'False' }}
      CIHUB_VERBOSE: ${{ needs.load-settings.outputs.debug_verbose == 'true' && 'True' || 'False' }}
      CIHUB_DEBUG_CONTEXT: ${{ needs.load-settings.outputs.debug_debug_context == 'true' && 'True' || 'False' }}
      CIHUB_EMIT_TRIAGE: ${{ needs.load-settings.outputs.debug_emit_triage == 'true' && 'True' || 'False' }}

    steps:
      - name: Harden Runner
        if: ${{ needs.load-settings.outputs.security_harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: ${{ needs.load-settings.outputs.security_harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Discover Repos
        id: discover
        env:
          INPUT_REPOS: ${{ inputs.repos }}
          INPUT_RUN_GROUP: ${{ inputs.run_group }}
        run: cihub discover --central-only --repos "${INPUT_REPOS:-}" --run-group "${INPUT_RUN_GROUP:-}" --github-output

  # ============================================================================
  # Run CI for Each Repo (via cihub ci)
  # ============================================================================
  test-repo:
    name: "Test: ${{ matrix.config_basename }}"
    runs-on: ubuntu-latest
    needs: [load-settings, discover]
    if: needs.discover.outputs.count > 0
    permissions:
      contents: read
      security-events: write  # For CodeQL SARIF upload
    env:
      CIHUB_DEBUG: ${{ needs.load-settings.outputs.debug_enabled == 'true' && 'True' || 'False' }}
      CIHUB_VERBOSE: ${{ needs.load-settings.outputs.debug_verbose == 'true' && 'True' || 'False' }}
      CIHUB_DEBUG_CONTEXT: ${{ needs.load-settings.outputs.debug_debug_context == 'true' && 'True' || 'False' }}
      CIHUB_EMIT_TRIAGE: ${{ needs.load-settings.outputs.debug_emit_triage == 'true' && 'True' || 'False' }}
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Harden Runner
        if: ${{ needs.load-settings.outputs.security_harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: ${{ needs.load-settings.outputs.security_harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: hub
          persist-credentials: false

      - name: Checkout Target Repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ matrix.owner }}/${{ matrix.name }}
          ref: ${{ matrix.branch }}
          path: repo
          persist-credentials: false

      # Language-specific setup
      - name: Set up JDK ${{ matrix.java_version }}
        if: matrix.language == 'java'
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4.7.1
        with:
          java-version: '${{ matrix.java_version }}'
          distribution: 'temurin'
          cache: '${{ matrix.build_tool }}'

      - name: Set up Python ${{ matrix.python_version || '3.12' }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '${{ matrix.python_version || 3.12 }}'

      - name: Install cihub + tools
        run: pip install -e "hub[ci]"

      - name: Install Trivy
        if: ${{ matrix.run_trivy }}
        run: cihub hub-ci trivy-install --dest .cihub/tools --github-path

      - name: Initialize CodeQL (Java)
        if: ${{ matrix.run_codeql && matrix.language == 'java' }}
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        continue-on-error: true
        with:
          languages: java
          source-root: repo

      - name: Build for CodeQL (Java)
        if: ${{ matrix.run_codeql && matrix.language == 'java' }}
        env:
          WORKDIR: repo
        run: cihub hub-ci codeql-build --path "$WORKDIR"
        continue-on-error: true

      - name: Analyze CodeQL (Java)
        if: ${{ matrix.run_codeql && matrix.language == 'java' }}
        id: codeql_analyze_java
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        continue-on-error: true
        with:
          category: "/language:java"

      - name: Initialize CodeQL (Python)
        if: ${{ matrix.run_codeql && matrix.language == 'python' }}
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        continue-on-error: true
        with:
          languages: python
          source-root: repo

      - name: Analyze CodeQL (Python)
        if: ${{ matrix.run_codeql && matrix.language == 'python' }}
        id: codeql_analyze_python
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        continue-on-error: true
        with:
          category: "/language:python"

      - name: Run cihub ci
        env:
          CONFIG_BASENAME: ${{ matrix.config_basename }}
          CORRELATION_ID: ${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.config_basename }}
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ needs.load-settings.outputs.write_github_summary }}
          CIHUB_RUN_MUTMUT: ${{ needs.load-settings.outputs.skip_mutation == 'true' && 'false' || matrix.run_mutmut }}
          CIHUB_RUN_TRIVY: ${{ matrix.run_trivy }}
          CIHUB_RUN_CODEQL: ${{ matrix.run_codeql }}
          CIHUB_CODEQL_RAN: ${{ matrix.run_codeql }}
          CIHUB_CODEQL_SUCCESS: ${{ steps.codeql_analyze_java.outcome == 'success' || steps.codeql_analyze_python.outcome == 'success' }}
        run: cihub ci --repo repo --config-from-hub "$CONFIG_BASENAME" --correlation-id "$CORRELATION_ID" --install-deps --output-dir .cihub

      - name: Read report outputs
        id: report
        if: ${{ always() && hashFiles('repo/.cihub/report.json') != '' }}
        run: cihub report outputs --report repo/.cihub/report.json

      - name: Upload CI Report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ matrix.config_basename }}${{ matrix.subdir_safe != '' && format('-{0}', matrix.subdir_safe) || '' }}-ci-report
          path: |
            repo/.cihub/report.json
            repo/.cihub/summary.md
            repo/.cihub/tool-outputs/*.json
            repo/.cihub/tool-outputs/*.log
            repo/.cihub/triage.json
            repo/.cihub/priority.json
            repo/.cihub/triage.md
            repo/.cihub/history.jsonl
          retention-days: ${{ matrix.retention_days || 30 }}
          if-no-files-found: warn

  # ============================================================================
  # Hub Summary
  # ============================================================================
  summary:
    name: Hub Summary
    runs-on: ubuntu-latest
    needs: [load-settings, discover, test-repo]
    if: always()
    permissions:
      contents: read
    env:
      CIHUB_DEBUG: ${{ needs.load-settings.outputs.debug_enabled == 'true' && 'True' || 'False' }}
      CIHUB_VERBOSE: ${{ needs.load-settings.outputs.debug_verbose == 'true' && 'True' || 'False' }}
      CIHUB_DEBUG_CONTEXT: ${{ needs.load-settings.outputs.debug_debug_context == 'true' && 'True' || 'False' }}
      CIHUB_EMIT_TRIAGE: ${{ needs.load-settings.outputs.debug_emit_triage == 'true' && 'True' || 'False' }}

    steps:
      - name: Harden Runner
        if: ${{ needs.load-settings.outputs.security_harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: ${{ needs.load-settings.outputs.security_harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Download All Reports
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          path: reports
          pattern: '*-ci-report'
        continue-on-error: true

      - name: Generate Hub Summary
        env:
          TOTAL_REPOS: ${{ needs.discover.outputs.count }}
          GH_RUN_NUMBER: ${{ github.run_number }}
          GH_EVENT_NAME: ${{ github.event_name }}
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ needs.load-settings.outputs.write_github_summary }}
          CIHUB_REPORT_INCLUDE_DETAILS: ${{ needs.load-settings.outputs.include_details }}
        run: cihub report aggregate --reports-dir reports --total-repos "${TOTAL_REPOS}" --output hub-report.json --details-output hub-report-details.md

      - name: Upload Hub Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: hub-report-${{ github.run_id }}
          path: hub-report.json
          retention-days: 30

      - name: Upload Hub Report Details
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: hub-report-details-${{ github.run_id }}
          path: hub-report-details.md
          retention-days: 30
          if-no-files-found: warn
