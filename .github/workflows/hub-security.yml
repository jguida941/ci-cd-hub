# ============================================================================
# CI/CD Hub - Security & Supply Chain
# ============================================================================
# Comprehensive security scanning for all connected repos:
#   - CodeQL (SAST)
#   - SBOM generation
#   - Dependency review
#   - ZAP DAST (for web apps)
#   - Secret scanning
# ============================================================================

name: "Hub: Security & Supply Chain"

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Specific repos (comma-separated, empty=all)'
        required: false
        type: string
      run_zap:
        description: 'Run ZAP DAST scan (requires running app)'
        required: false
        type: boolean
        default: false
      write_github_summary:
        description: 'Write summary to GITHUB_STEP_SUMMARY'
        required: false
        type: boolean
        default: true
      harden_runner_policy:
        description: 'Harden-runner policy: audit (default), block, or disabled'
        required: false
        type: string
        default: 'audit'

  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'

# Minimal default permissions - jobs override as needed
permissions:
  contents: read

jobs:
  # ============================================================================
  # Discover Repos
  # ============================================================================
  discover:
    name: Discover Repositories
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.repos.outputs.matrix }}
      count: ${{ steps.repos.outputs.count }}

    steps:
      - name: Harden Runner
        if: ${{ inputs.harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: ${{ inputs.harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false
          ref: ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Build Repo Matrix
        id: repos
        env:
          # Pass input via env var to prevent shell injection
          INPUT_REPOS: ${{ inputs.repos }}
        run: cihub discover --repos "${INPUT_REPOS:-}" --github-output

  # ============================================================================
  # Security Scan Each Repo
  # ============================================================================
  security-scan:
    name: "Security: ${{ matrix.name }}"
    runs-on: ubuntu-latest
    needs: discover
    if: needs.discover.outputs.count > 0
    permissions:
      contents: read
      security-events: write  # For CodeQL SARIF upload
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Harden Runner
        if: ${{ inputs.harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: ${{ inputs.harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: hub
          fetch-depth: 1
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e "hub[ci]"

      - name: Checkout Target Repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ matrix.owner }}/${{ matrix.name }}
          path: repo
          fetch-depth: 1
          persist-credentials: false
          token: ${{ secrets.HUB_DISPATCH_TOKEN || github.token }}
        continue-on-error: true

      - name: Verify checkout
        id: repo-check
        env:
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
        run: cihub hub-ci repo-check --path repo --owner "$MATRIX_OWNER" --name "$MATRIX_NAME" --github-output

      # ========================================
      # CODEQL ANALYSIS
      # ========================================
      - name: Check for source code
        id: source-check
        if: steps.repo-check.outputs.present == 'true'
        working-directory: repo
        env:
          MATRIX_LANGUAGE: ${{ matrix.language }}
        run: cihub hub-ci source-check --path . --language "$MATRIX_LANGUAGE" --github-output

      - name: Initialize CodeQL
        uses: github/codeql-action/init@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        if: steps.repo-check.outputs.present == 'true' && steps.source-check.outputs.has_source == 'true'
        continue-on-error: true
        with:
          languages: ${{ matrix.language == 'java' && 'java-kotlin' || 'python' }}
          source-root: repo

      - name: Set up JDK (for Java CodeQL)
        if: steps.repo-check.outputs.present == 'true' && steps.source-check.outputs.has_source == 'true' && matrix.language == 'java'
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4.8.0
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build for CodeQL (Java)
        if: steps.repo-check.outputs.present == 'true' && steps.source-check.outputs.has_source == 'true' && matrix.language == 'java'
        working-directory: repo
        run: cihub hub-ci codeql-build --path .
        continue-on-error: true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        if: steps.repo-check.outputs.present == 'true' && steps.source-check.outputs.has_source == 'true'
        continue-on-error: true
        with:
          category: "/language:${{ matrix.language }}"

      # ========================================
      # SBOM GENERATION
      # ========================================
      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0.21.0
        if: steps.repo-check.outputs.present == 'true'
        continue-on-error: true
        with:
          path: repo
          artifact-name: sbom-${{ matrix.name }}-${{ github.run_id }}.spdx.json
          output-file: sbom-${{ matrix.name }}.spdx.json

      # ========================================
      # DEPENDENCY REVIEW (for PRs)
      # ========================================
      - name: Dependency Review
        if: steps.repo-check.outputs.present == 'true' && github.event_name == 'pull_request'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: high

      # ========================================
      # PYTHON SPECIFIC SECURITY
      # ========================================
      - name: Set up Python
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'python'
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: "[Python] Install security tools"
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'python'
        working-directory: repo
        run: pip install pip-audit==2.7.3 bandit==1.7.10 ruff==0.8.4

      - name: "[Python] pip-audit"
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'python'
        id: pip-audit
        working-directory: repo
        run: cihub hub-ci security-pip-audit --path . --report pip-audit-report.json --requirements requirements.txt --github-output
        continue-on-error: true

      - name: "[Python] Bandit"
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'python'
        id: bandit
        working-directory: repo
        run: cihub hub-ci security-bandit --path . --report bandit-report.json --github-output
        continue-on-error: true

      - name: "[Python] Ruff Security Rules"
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'python'
        id: ruff-security
        working-directory: repo
        run: cihub hub-ci security-ruff --path . --report ruff-security.json --github-output
        continue-on-error: true

      # ========================================
      # JAVA SPECIFIC SECURITY
      # ========================================
      - name: "[Java] OWASP Dependency-Check"
        if: steps.repo-check.outputs.present == 'true' && matrix.language == 'java'
        id: owasp
        working-directory: repo
        run: cihub hub-ci security-owasp --path . --github-output
        continue-on-error: true

      # ========================================
      # GENERATE SECURITY REPORT
      # ========================================
      - name: Generate Security Summary
        env:
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_LANGUAGE: ${{ matrix.language }}
          HAS_SOURCE: ${{ steps.source-check.outputs.has_source || 'false' }}
          PIP_AUDIT_VULNS: ${{ steps.pip-audit.outputs.vulnerabilities || '0' }}
          BANDIT_HIGH: ${{ steps.bandit.outputs.high || '0' }}
          RUFF_ISSUES: ${{ steps.ruff-security.outputs.issues || '0' }}
          OWASP_CRITICAL: ${{ steps.owasp.outputs.critical || '0' }}
          OWASP_HIGH: ${{ steps.owasp.outputs.high || '0' }}
        run: |
          cihub report security-summary --mode repo \
            --repo "$MATRIX_NAME" \
            --language "$MATRIX_LANGUAGE" \
            --has-source "$HAS_SOURCE" \
            --pip-audit-vulns "$PIP_AUDIT_VULNS" \
            --bandit-high "$BANDIT_HIGH" \
            --ruff-issues "$RUFF_ISSUES" \
            --owasp-critical "$OWASP_CRITICAL" \
            --owasp-high "$OWASP_HIGH"

      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: security-reports-${{ matrix.name }}-${{ github.run_id }}
          path: |
            repo/*-report.json
            repo/ruff-security.json
            repo/**/dependency-check-report.*
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================================
  # ZAP DAST Scan (Optional)
  # ============================================================================
  zap-scan:
    name: "ZAP DAST: ${{ matrix.name }}"
    runs-on: ubuntu-latest
    needs: discover
    if: inputs.run_zap == true && needs.discover.outputs.count > 0
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}

    steps:
      - name: Harden Runner
        if: ${{ inputs.harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: ${{ inputs.harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: hub
          fetch-depth: 1
          persist-credentials: false

      - name: Checkout Target Repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ matrix.owner }}/${{ matrix.name }}
          path: repo
          fetch-depth: 1
          persist-credentials: false
          token: ${{ secrets.HUB_DISPATCH_TOKEN || github.token }}
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e "hub[ci]"

      - name: Verify checkout
        id: repo-check
        env:
          MATRIX_OWNER: ${{ matrix.owner }}
          MATRIX_NAME: ${{ matrix.name }}
        run: cihub hub-ci repo-check --path repo --owner "$MATRIX_OWNER" --name "$MATRIX_NAME" --github-output

      - name: Check for Docker Compose
        if: steps.repo-check.outputs.present == 'true' && inputs.run_zap == true
        id: check-docker
        working-directory: repo
        run: cihub hub-ci docker-compose-check --path . --github-output

      - name: Start Application
        if: steps.repo-check.outputs.present == 'true' && inputs.run_zap == true && steps.check-docker.outputs.has_docker == 'true'
        working-directory: repo
        run: docker compose up -d

      - name: Wait for app startup
        if: steps.repo-check.outputs.present == 'true' && inputs.run_zap == true && steps.check-docker.outputs.has_docker == 'true'
        run: sleep 60

      - name: ZAP Baseline Scan
        if: steps.repo-check.outputs.present == 'true' && inputs.run_zap == true && steps.check-docker.outputs.has_docker == 'true'
        uses: zaproxy/action-baseline@66042c8e7e24680119199a017e5b0e8603bf4dae # v0.12.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          allow_issue_writing: false
        continue-on-error: true

      - name: Stop Application
        if: steps.repo-check.outputs.present == 'true' && inputs.run_zap == true && steps.check-docker.outputs.has_docker == 'true'
        working-directory: repo
        run: docker compose down

      - name: Generate ZAP Summary
        env:
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
          MATRIX_NAME: ${{ matrix.name }}
          REPO_PRESENT: ${{ steps.repo-check.outputs.present || 'false' }}
          RUN_ZAP: ${{ inputs.run_zap || 'false' }}
          HAS_DOCKER: ${{ steps.check-docker.outputs.has_docker || 'false' }}
        run: cihub report security-summary --mode zap --repo "$MATRIX_NAME" --repo-present "$REPO_PRESENT" --run-zap "$RUN_ZAP" --has-docker "$HAS_DOCKER"

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [discover, security-scan]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        if: ${{ inputs.harden_runner_policy != 'disabled' }}
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: ${{ inputs.harden_runner_policy || 'audit' }}

      - name: Checkout Hub
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install cihub
        run: pip install -e ".[ci]"

      - name: Generate Summary
        env:
          CIHUB_WRITE_GITHUB_SUMMARY: ${{ inputs.write_github_summary || 'true' }}
          REPO_COUNT: ${{ needs.discover.outputs.count }}
          RUN_NUMBER: ${{ github.run_number }}
        run: cihub report security-summary --mode overall --repo-count "$REPO_COUNT" --run-number "$RUN_NUMBER"
